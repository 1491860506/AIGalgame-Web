import{_ as J,c as o,o as n,a,b as k,e as h,t as f,F as y,f as p,n as E,w as x,p as I,K as G,m as L,M as $,N as z,G as V,O as W,P as K,Q as q,R as Q,I as H}from"./index-DyH5Twdd.js";const X={name:"ReadResources",props:{storyTitle:{type:String,required:!0}},data(){return{isLoading:!0,loadingPreview:!1,error:null,previewError:!1,resourceCategories:{voice:[],images:[],music:[]},storyData:{},characterData:[],selectedResource:null,previewUrl:null,objectUrls:{},audioDirExists:!1,imageDirExists:!1,musicDirExists:!1,storyDirExists:!1,characterFileExists:!1,missingAudioByStory:{},missingTitleImage:null,missingCharacterImages:[],missingBackgroundsByStory:{},missingMusicFiles:[],expectedMusicFiles:["background.mp3","background1.mp3"],isGenerating:{},showCharacterDialog:!1,characterSelectionList:[],selectAllCharacters:!1,isCharacterRegenerating:!1,showBackgroundDialog:!1,backgroundSelectionList:[],selectAllBackgrounds:!1,isBackgroundRegenerating:!1,currentStoryId:null}},computed:{classifiedAudio(){const r={},e=[],c=`/data/${this.storyTitle}/audio/`;this.resourceCategories.voice.forEach(t=>{if(!t.path.startsWith(c)){console.warn(`Audio file ${t.path} does not start with expected base path ${c}. Skipping.`),e.push(t);return}const l=t.path.substring(c.length).split("/");if(l.length===2&&/^\d+$/.test(l[0])&&/^\d+\.wav$/.test(l[1])){const u=l[0],d=l[1].match(/^(\d+)\.wav$/),w=parseInt(d[1]);if(this.storyData&&this.storyData[u]){const v=this.storyData[u];let D=null;if(v&&typeof v=="object"&&Array.isArray(v.conversations)?D=v.conversations.find(S=>S&&typeof S=="object"&&S.id===w):console.warn(`Invalid story data structure for story ID ${u} when classifying audio ${t.name}`,v),D){const S=typeof D.text=="string"?D.text:`(对话 ${w} 无文本)`;r[u]||(r[u]=[]),r[u].push({file:t,text:S,storyId:u,audioId:w})}else console.warn(`Audio file ${t.path} links to story ${u}, but conversation ID ${w} not found.`),e.push(t)}else console.warn(`Audio file ${t.path} links to non-existent or invalid story data for ID ${u}.`),e.push(t)}else console.warn(`Audio file ${t.path} has unexpected path structure (expected /storyid/id.wav).`),e.push(t)});for(const t in r)r[t].sort((i,l)=>i.audioId-l.audioId);const m=Object.keys(r).sort((t,i)=>Number(t)-Number(i)),s={};return m.forEach(t=>s[t]=r[t]),e.sort((t,i)=>t.path.localeCompare(i.path)),{byStory:s,uncategorized:e}},classifiedImages(){const r=[],e=[],c={byStory:{},uncategorized:[]},m=new Set(Array.isArray(this.characterData)?this.characterData.map(i=>i&&typeof i=="object"?i.name:null).filter(Boolean):[]);this.resourceCategories.images.forEach(i=>{const l=i.name.replace(/\.png$/,"");if(l==="title")e.push(i);else if(m.has(l))r.push(i);else{let u=[];for(const g in this.storyData){const d=this.storyData[g];d&&typeof d=="object"&&Array.isArray(d.conversations)?d.conversations.some(v=>v&&typeof v=="object"&&v.place===l&&v.place!=="")&&u.push(g):console.warn(`Invalid story data structure for story ID ${g} during image classification`,d)}u.length>0?(u.sort((g,d)=>Number(g)-Number(d)),u.forEach(g=>{c.byStory[g]||(c.byStory[g]=[]),c.byStory[g].push({...i})})):c.uncategorized.push(i)}}),r.sort((i,l)=>i.name.localeCompare(l.name));const s=Object.keys(c.byStory).sort((i,l)=>Number(i)-Number(l)),t={};return s.forEach(i=>{t[i]=c.byStory[i],t[i].sort((l,u)=>l.name.localeCompare(u.name))}),c.byStory=t,c.uncategorized.sort((i,l)=>i.name.localeCompare(l.name)),{characters:r,backgrounds:c,title:e}},hasMissingAudioResources(){return Object.values(this.missingAudioByStory).some(r=>r.length>0)},hasMissingImageResources(){return this.missingTitleImage||this.missingCharacterImages.length>0||Object.values(this.missingBackgroundsByStory).some(r=>r.length>0)},hasMissingResources(){return this.hasMissingAudioResources||this.hasMissingImageResources||this.missingMusicFiles.length>0},hasAudioResources(){return Object.keys(this.classifiedAudio.byStory).length>0||this.classifiedAudio.uncategorized.length>0},hasImageResources(){return this.classifiedImages.characters.length>0||this.classifiedImages.title.length>0||Object.keys(this.classifiedImages.backgrounds.byStory).length>0||this.classifiedImages.backgrounds.uncategorized.length>0},hasMusicResources(){return this.resourceCategories.music.length>0},hasResources(){return this.hasAudioResources||this.hasImageResources||this.hasMusicResources},hasSelectedCharacters(){return this.characterSelectionList.some(r=>r.selected)},hasSelectedBackgrounds(){return this.backgroundSelectionList.some(r=>r.selected)},isAnyCharacterGenerating(){return Object.keys(this.isGenerating).some(r=>r.startsWith("image-character-")&&this.isGenerating[r])}},watch:{storyTitle:{immediate:!0,handler(){this.fetchResources()}}},mounted(){},beforeDestroy(){this.stopAudio(),this.releaseObjectUrls()},methods:{setStoryTitleConfig(){try{const r=JSON.parse(localStorage.getItem("aiGalgameConfig"));r.剧情||(r.剧情={}),r.剧情.story_title=this.storyTitle,localStorage.setItem("aiGalgameConfig",JSON.stringify(r)),console.log("已设置本地存储的剧情title为:",this.storyTitle)}catch(r){console.error("设置localStorage配置失败:",r),this.showNotification("设置生成配置失败","error")}},async regenerateAudio(r){this.setStoryTitleConfig(),this.isGenerating[`audio-${r}`]=!0;try{const e=this.classifiedAudio.byStory[r]||[],c=this.missingAudioByStory[r]||[];try{await Q(r),console.log(`已重新生成语音: 故事ID ${r}`)}catch(m){console.error(`生成语音失败: 故事ID ${r}`,m),this.showNotification(`生成语音失败: 故事ID ${r}`,"error")}finally{}this.showNotification(`故事片段 ${r} 的语音生成完成`,"success"),await this.fetchResources()}catch(e){console.error(`重新生成语音失败: 故事ID ${r}`,e),this.showNotification(`重新生成语音失败: 故事片段 ${r}`,"error")}finally{this.isGenerating[`audio-${r}`]=!1}},async regenerateTitleImage(){this.setStoryTitleConfig(),this.isGenerating["image-title"]=!0;try{await q(1),console.log("已重新生成标题图片"),this.showNotification("标题图片生成完成","success"),await this.fetchResources()}catch(r){console.error("生成标题图片失败:",r),this.showNotification("生成标题图片失败","error")}finally{this.isGenerating["image-title"]=!1}},showCharacterSelection(r){this.isCharacterRegenerating=r,r?this.characterSelectionList=Array.isArray(this.characterData)?this.characterData.filter(e=>e&&typeof e=="object"&&e.name).map(e=>({name:e.name,selected:!1})):[]:this.characterSelectionList=this.missingCharacterImages.map(e=>({name:e.name,selected:!0})),this.selectAllCharacters=this.characterSelectionList.length>0&&this.characterSelectionList.every(e=>e.selected),this.showCharacterDialog=!0},closeCharacterDialog(){this.showCharacterDialog=!1,this.characterSelectionList=[]},toggleAllCharacters(){this.characterSelectionList.forEach(r=>{r.selected=this.selectAllCharacters})},async confirmCharacterSelection(){this.setStoryTitleConfig();const r=this.characterSelectionList.filter(e=>e.selected).map(e=>e.name);if(r.length===0){this.showNotification("请至少选择一个人物","warning");return}this.closeCharacterDialog(),this.isGenerating["image-characters"]=!0,r.forEach(e=>{this.isGenerating[`image-character-${e}`]=!0});try{await K(r),console.log("已生成人物图片:",r),this.showNotification(`已生成 ${r.length} 个人物图片`,"success"),await this.fetchResources()}catch(e){console.error("生成人物图片失败:",e),this.showNotification("生成人物图片失败","error")}finally{this.isGenerating["image-characters"]=!1,r.forEach(e=>{this.isGenerating[`image-character-${e}`]=!1})}},showBackgroundSelection(r,e){this.currentStoryId=r,this.isBackgroundRegenerating=e;const c=this.storyData[r],m=new Set;if(c&&Array.isArray(c.conversations)&&c.conversations.forEach(s=>{s&&s.place&&s.place!==""&&m.add(s.place)}),e)this.backgroundSelectionList=Array.from(m).map(s=>({name:s,selected:!1}));else{const s=this.getMissingBackgroundsForStory(r);this.backgroundSelectionList=s.map(t=>({name:t.name,selected:!0}))}this.selectAllBackgrounds=this.backgroundSelectionList.length>0&&this.backgroundSelectionList.every(s=>s.selected),this.showBackgroundDialog=!0},closeBackgroundDialog(){this.showBackgroundDialog=!1,this.backgroundSelectionList=[],this.currentStoryId=null},toggleAllBackgrounds(){this.backgroundSelectionList.forEach(r=>{r.selected=this.selectAllBackgrounds})},async confirmBackgroundSelection(){this.setStoryTitleConfig();const r=this.currentStoryId,e=this.backgroundSelectionList.filter(c=>c.selected).map(c=>c.name);if(e.length===0){this.showNotification("请至少选择一个背景","warning");return}this.closeBackgroundDialog(),this.isGenerating[`image-bg-${r}`]=!0,e.forEach(c=>{this.isGenerating[`image-bg-${r}-${c}`]=!0});try{await z(r),console.log(`已合并故事数据: 故事ID ${r}`);const c=`/data/${this.storyTitle}/story/place.json`,m=JSON.stringify(e);try{await V(c,m),console.log(`已写入地点数据: ${c}`,e)}catch(s){throw console.error(`写入地点数据失败: ${c}`,s),new Error(`写入地点数据失败: ${s.message}`)}await W(1),console.log(`已生成背景图片: 地点 ${e.join(", ")}`),this.showNotification(`已生成 ${e.length} 个背景图片`,"success"),await this.fetchResources()}catch(c){console.error(`生成背景图片失败: 故事ID ${r}`,c),this.showNotification("生成背景图片失败","error")}finally{this.isGenerating[`image-bg-${r}`]=!1,e.forEach(c=>{this.isGenerating[`image-bg-${r}-${c}`]=!1})}},async regenerateMusic(){this.setStoryTitleConfig(),this.isGenerating.music=!0;try{await $(console.log),console.log("已生成背景音乐"),this.showNotification("背景音乐生成完成","success"),await this.fetchResources()}catch(r){console.error("生成背景音乐失败:",r),this.showNotification("生成背景音乐失败","error")}finally{this.isGenerating.music=!1}},async fetchResources(){this.isLoading=!0,this.error=null,this.resourceCategories={voice:[],images:[],music:[]},this.storyData={},this.characterData=[],this.audioDirExists=!1,this.imageDirExists=!1,this.musicDirExists=!1,this.storyDirExists=!1,this.characterFileExists=!1,this.selectedResource=null,this.previewUrl=null,this.releaseObjectUrls(),this.missingAudioByStory={},this.missingTitleImage=null,this.missingCharacterImages=[],this.missingBackgroundsByStory={},this.missingMusicFiles=[],this.isGenerating={};const r=`/data/${this.storyTitle}`,e=`${r}/audio`,c=`${r}/images`,m=`${r}/music`,s=`${r}/story`,t=`${r}/character.json`,i=async g=>{try{return{items:await H(g)||[],exists:!0}}catch(d){if(d.message&&(d.message.includes("目录不存在")||d.message.includes("标题")||d.message.includes("不存在")))return console.warn(`Directory "${g}" does not exist or access denied, skipping listing.`,d.message),{items:[],exists:!1};throw console.error(`Failed to list directory "${g}":`,d),d}},l=async g=>{try{const d=await L(g);return d===void 0?(console.warn(`File "${g}" read returned undefined, treating as non-existent.`),{data:null,exists:!1}):{data:d,exists:!0}}catch(d){if(d.message&&(d.message.includes("文件不存在")||d.message.includes("不存在")||d.message.includes("无法读取")))return console.warn(`File "${g}" does not exist or access denied, skipping read.`,d.message),{data:null,exists:!1};throw console.error(`Failed to read file "${g}":`,d),d}},u=(g,d)=>{if(typeof g=="string")try{return JSON.parse(g)}catch(w){throw console.error(`Failed to parse JSON string from ${d}:`,w),new Error(`Invalid JSON format in ${d}`)}else if(g instanceof ArrayBuffer)try{return JSON.parse(new TextDecoder().decode(g))}catch(w){throw console.error(`Failed to decode/parse ArrayBuffer from ${d}:`,w),new Error(`Invalid JSON format (from ArrayBuffer) in ${d}`)}else{if(typeof g=="object"&&g!==null)return g;throw new Error(`Unexpected or invalid data type for ${d}: ${typeof g}`)}};try{const{data:g,exists:d}=await l(t);if(this.characterFileExists=d,d&&g!==null)try{this.characterData=u(g,t),Array.isArray(this.characterData)?console.log("Character data loaded successfully."):(console.error("Character data is not an array:",this.characterData),this.showNotification("character.json 格式错误 (应为数组)","error"),this.characterData=[])}catch(_){this.showNotification(`处理 character.json 失败: ${_.message}`,"error"),this.characterData=[]}else console.log(`Character file "${t}" ${d?"read returned null":"does not exist or is inaccessible."}`);const{items:w,exists:v}=await i(s);if(this.storyDirExists=v,v&&w.length>0){const _=w.filter(b=>!b.isFolder&&b.name.endsWith(".json")&&/^\d+$/.test(b.name.replace(/\.json$/,"")));console.log(`Found ${_.length} numeric story JSON files to process.`);const T=_.map(async b=>{const{data:C,exists:B}=await l(b.path);if(B&&C!==null)try{const M=b.name.replace(/\.json$/,""),A=u(C,b.path);if(typeof A!="object"||A===null||!Array.isArray(A.conversations))throw new Error("Missing or non-array 'conversations' property.");return{id:M,json:A}}catch(M){return console.error(`Failed to process story JSON ${b.name}:`,M),this.showNotification(`处理故事 JSON "${b.name}" 失败: ${M.message}`,"error"),null}else return console.log(`Story file "${b.path}" ${B?"read returned null":"does not exist or is inaccessible."}`),null}),R=await Promise.all(T);this.storyData=R.reduce((b,C)=>(C&&C.id&&C.json&&(b[C.id]=C.json),b),{}),console.log("Story data loaded for IDs:",Object.keys(this.storyData))}else console.log(`Story directory "${s}" ${v?"is empty or contains no numeric JSON files":"does not exist or is inaccessible."}`);const{items:D,exists:S}=await i(e);this.audioDirExists=S;const N=[];if(S&&D.length>0){const _=D.filter(R=>R.isFolder&&/^\d+$/.test(R.name)).map(async R=>{const b=R.name,C=`${e}/${b}`;try{const{items:B,exists:M}=await i(C);return M?B.filter(A=>!A.isFolder&&A.name.endsWith(".wav")&&/^\d+\.wav$/.test(A.name)):[]}catch(B){return console.error(`Error listing audio sub-directory ${C}:`,B),[]}});(await Promise.all(_)).forEach(R=>N.push(...R)),console.log("Audio items fetched from story subfolders:",N.length)}else console.log(`Audio directory "${e}" ${S?"is empty or contains no numeric subfolders":"does not exist or is inaccessible."}`);this.resourceCategories.voice=N;const{items:U,exists:F}=await i(c);this.imageDirExists=F,F?(this.resourceCategories.images=U.filter(_=>!_.isFolder&&_.name.endsWith(".png")),console.log("Image items fetched:",this.resourceCategories.images.length)):console.log(`Image directory "${c}" does not exist or is inaccessible.`);const{items:O,exists:j}=await i(m);this.musicDirExists=j,j?(this.resourceCategories.music=O.filter(_=>!_.isFolder&&_.name.endsWith(".mp3")),console.log("Music items fetched:",this.resourceCategories.music.length)):console.log(`Music directory "${m}" does not exist or is inaccessible.`),this.generateMissingResourcesList();const P=this.resourceCategories.voice.length+this.resourceCategories.images.length+this.resourceCategories.music.length;console.log(`Total raw resource files loaded for "${this.storyTitle}": ${P}`)}catch(g){console.error("加载资源列表或元数据时发生严重错误:",g),this.error=g.message||"发生未知错误",this.showNotification("加载资源时发生严重错误","error")}finally{this.isLoading=!1}},generateMissingResourcesList(){this.findMissingAudioFiles(),this.findMissingImageFiles(),this.findMissingMusicFiles(),console.log("生成缺失资源列表完成"),console.log("- 缺失语音:",Object.keys(this.missingAudioByStory).length>0),console.log("- 缺失封面图:",!!this.missingTitleImage),console.log("- 缺失角色图:",this.missingCharacterImages.length),console.log("- 缺失背景图:",Object.keys(this.missingBackgroundsByStory).length),console.log("- 缺失音乐:",this.missingMusicFiles.length)},findMissingAudioFiles(){for(const r in this.storyData){const e=this.storyData[r];if(e&&Array.isArray(e.conversations)){const c=this.classifiedAudio.byStory[r]||[],m=new Set(c.map(t=>t.audioId)),s=[];e.conversations.forEach(t=>{if(t&&t.character&&t.character!==""&&typeof t.id=="number"){const i=t.id;if(!m.has(i)){const l=t.text.replace(/[\(（].*?[\)）]/g,"").replace(/ /g,"，").replace(/\n/g,"。");for(;l.startsWith("，")||l.startsWith("。");)l=l.substring(1);l.trim()&&s.push({id:i,name:`${i}.wav`,text:t.text||`对话 ${i}`,path:`/data/${this.storyTitle}/audio/${r}/${i}.wav`,type:"audio",isMissing:!0})}}}),s.length>0&&(this.missingAudioByStory[r]=s)}}},findMissingImageFiles(){if(this.classifiedImages.title.length>0||(this.missingTitleImage={name:"title",path:`/data/${this.storyTitle}/images/title.png`,type:"image",isMissing:!0}),Array.isArray(this.characterData)){const e=new Set(this.classifiedImages.characters.map(c=>c.name.replace(/\.png$/,"")));this.characterData.forEach(c=>{c&&c.name&&!e.has(c.name)&&this.missingCharacterImages.push({name:c.name,path:`/data/${this.storyTitle}/images/${c.name}.png`,type:"image",isMissing:!0})})}for(const e in this.storyData){const c=this.storyData[e];if(c&&Array.isArray(c.conversations)){const m=new Set;if(c.conversations.forEach(s=>{s&&s.place&&s.place!==""&&m.add(s.place)}),m.size>0){const s=this.classifiedImages.backgrounds.byStory[e]||[],t=new Set(s.map(l=>l.name.replace(/\.png$/,""))),i=[];m.forEach(l=>{t.has(l)||i.push({name:l,path:`/data/${this.storyTitle}/images/${l}.png`,type:"image",isMissing:!0})}),i.length>0&&(this.missingBackgroundsByStory[e]=i)}}}},findMissingMusicFiles(){const r=new Set(this.resourceCategories.music.map(e=>e.name));this.expectedMusicFiles.forEach(e=>{r.has(e)||this.missingMusicFiles.push({name:e,path:`/data/${this.storyTitle}/music/${e}`,type:"audio",isMissing:!0})})},getMissingAudioForStory(r){return this.missingAudioByStory[r]||[]},getMissingBackgroundsForStory(r){return this.missingBackgroundsByStory[r]||[]},handleMissingResourceClick(r){this.showNotification(`资源 "${r.name}" 不存在，无法预览`,"warning"),this.selectedResource=r,this.previewUrl=null,this.previewError=!0,this.loadingPreview=!1},async selectResource(r,e){if(this.selectedResource&&this.selectedResource.path===r.path){e==="audio"&&this.$refs.audioPlayer&&(this.$refs.audioPlayer.paused?this.$refs.audioPlayer.play().catch(c=>console.error("继续播放音频失败:",c)):this.$refs.audioPlayer.pause());return}this.stopAudio(),this.releaseObjectUrls(),this.selectedResource=null,this.previewUrl=null,this.previewError=!1,this.loadingPreview=!0,this.selectedResource={...r,type:e},console.log("Selecting resource:",this.selectedResource);try{const c=await L(r.path);if(c==null)throw new Error("读取文件失败 (null/undefined)");if(console.log(`File read successful for ${r.name}, data type:`,c.constructor.name),c instanceof Blob||c instanceof ArrayBuffer){const m=c instanceof ArrayBuffer?new Blob([c]):c,s=URL.createObjectURL(m);this.previewUrl=s,this.objectUrls[r.path]=s,console.log("Blob URL created:",s),e==="audio"?(await this.$nextTick(),this.$refs.audioPlayer?(this.$refs.audioPlayer.load(),this.$refs.audioPlayer.play().catch(t=>{console.warn("音频自动播放失败:",t),this.showNotification("音频自动播放失败，请手动播放","warning"),this.previewError=!1})):(console.error("Audio element ref not available after nextTick."),this.previewError=!0,this.showNotification("无法获取音频播放器","error"))):e==="image"?console.log("Image preview URL set."):this.previewError=!0}else console.warn(`读取的数据类型 (${c.constructor.name}) 无法创建 Blob URL.`),this.previewError=!0,this.showNotification("无法预览此文件类型","warning")}catch(c){console.error(`选择或读取文件 ${r.path} 失败:`,c),this.previewError=!0,this.showNotification(`加载预览 "${r.name}" 失败: ${c.message}`,"error")}finally{this.loadingPreview=!1,console.log("Preview loading finished.")}},stopAudio(){console.log("Attempting to stop audio..."),this.$refs.audioPlayer&&(this.$refs.audioPlayer.paused||this.$refs.audioPlayer.pause(),this.$refs.audioPlayer.removeAttribute("src"),this.$refs.audioPlayer.load(),console.log("Audio stopped and source cleared."))},handleAudioError(r){console.error("音频播放错误:",r);const e=r.target.error;let c="音频播放失败";if(e){switch(e.code){case MediaError.MEDIA_ERR_ABORTED:c+=": 中断";break;case MediaError.MEDIA_ERR_NETWORK:c+=": 网络错误";break;case MediaError.MEDIA_ERR_DECODE:c+=": 解码错误";break;case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:c+=": 源不支持";break;default:c+=": 未知";break}console.error("MediaError code:",e.code,"message:",e.message)}this.previewError=!0,this.showNotification(c,"error"),this.stopAudio()},handleAudioEnded(){console.log("音频播放结束")},releaseObjectUrls(){console.log("Releasing object URLs...");for(const r in this.objectUrls)this.objectUrls[r]&&(URL.revokeObjectURL(this.objectUrls[r]),console.log("Revoked URL for:",r));this.objectUrls={}},showNotification(r,e="info"){this._isDestroyed?console.log(`[ReadResources][${e.toUpperCase()}][Destroyed] ${r}`):(this.$emit("show-message",{title:e,message:r}),console.log(`[ReadResources][${e.toUpperCase()}] ${r}`))},close(){this.$emit("close")}}},Y={class:"resource-viewer"},Z={key:0,class:"loading-indicator"},ee={key:1,class:"error-state"},se={key:2,class:"resource-content"},ie={class:"resource-list-area"},te={key:0,class:"empty-state"},re={key:0},oe={key:1},ne={key:0,class:"resource-category"},ae={class:"resource-items"},le=["onClick"],ce=["onClick"],ue={key:0,class:"fas fa-spinner fa-spin resource-icon missing-icon"},ge={key:1,class:"fas fa-volume-up resource-icon missing-icon"},de=["onClick","disabled"],he={key:0,class:"fas fa-spinner fa-spin"},me={key:1,class:"fas fa-plus"},fe={key:0,class:"voice-folder missing-folder"},ye=["onClick","disabled"],pe={key:0,class:"fas fa-spinner fa-spin"},ke={key:1,class:"fas fa-sync-alt"},be={class:"resource-items"},ve=["onClick"],we={key:0,class:"fas fa-spinner fa-spin resource-icon missing-icon"},_e={key:1,class:"fas fa-volume-up resource-icon missing-icon"},Ce=["onClick","disabled"],Se={key:0,class:"fas fa-spinner fa-spin"},Re={key:1,class:"fas fa-plus"},Ae={key:0,class:"voice-folder"},De={class:"resource-items"},Ee=["onClick"],xe={key:1,class:"resource-category"},Be={key:0,class:"voice-folder"},Me=["disabled"],Ie={key:0,class:"fas fa-spinner fa-spin"},Ge={key:1,class:"fas fa-sync-alt"},Ne={class:"resource-items"},Fe=["onClick"],je={key:0,class:"fas fa-spinner fa-spin resource-icon missing-icon"},Te={key:1,class:"fas fa-image resource-icon missing-icon"},Le=["disabled"],Ue={key:0,class:"fas fa-spinner fa-spin"},Oe={key:1,class:"fas fa-plus"},Pe={key:1,class:"voice-folder"},Je=["disabled"],$e={key:0,class:"fas fa-spinner fa-spin"},ze={key:1,class:"fas fa-sync-alt"},Ve={class:"resource-items"},We=["onClick"],Ke=["onClick"],qe={key:0,class:"fas fa-spinner fa-spin resource-icon missing-icon"},Qe={key:1,class:"fas fa-image resource-icon missing-icon"},He=["disabled"],Xe={key:0,class:"fas fa-spinner fa-spin"},Ye={key:1,class:"fas fa-plus"},Ze={key:2,class:"voice-folder"},es=["onClick","disabled"],ss={key:0,class:"fas fa-spinner fa-spin"},is={key:1,class:"fas fa-sync-alt"},ts={class:"resource-items"},rs=["onClick"],os=["onClick"],ns={key:0,class:"fas fa-spinner fa-spin resource-icon missing-icon"},as={key:1,class:"fas fa-image resource-icon missing-icon"},ls=["onClick","disabled"],cs={key:0,class:"fas fa-spinner fa-spin"},us={key:1,class:"fas fa-plus"},gs={key:0,class:"voice-folder sub-folder missing-folder"},ds=["onClick","disabled"],hs={key:0,class:"fas fa-spinner fa-spin"},ms={key:1,class:"fas fa-sync-alt"},fs={class:"resource-items"},ys=["onClick"],ps={key:0,class:"fas fa-spinner fa-spin resource-icon missing-icon"},ks={key:1,class:"fas fa-image resource-icon missing-icon"},bs=["onClick","disabled"],vs={key:0,class:"fas fa-spinner fa-spin"},ws={key:1,class:"fas fa-plus"},_s={key:3,class:"voice-folder"},Cs={class:"resource-items"},Ss=["onClick"],Rs={key:2,class:"resource-category"},As=["disabled"],Ds={key:0,class:"fas fa-spinner fa-spin"},Es={key:1,class:"fas fa-sync-alt"},xs={class:"resource-items"},Bs=["onClick"],Ms=["onClick"],Is={key:0,class:"fas fa-spinner fa-spin resource-icon missing-icon"},Gs={key:1,class:"fas fa-music resource-icon missing-icon"},Ns=["disabled"],Fs={key:0,class:"fas fa-spinner fa-spin"},js={key:1,class:"fas fa-plus"},Ts={class:"resource-preview-area"},Ls={key:0,class:"preview-placeholder"},Us={key:1,class:"preview-content"},Os={class:"preview-container"},Ps=["src"],Js={key:1,class:"audio-preview"},$s=["src"],zs={key:2,class:"loading-indicator small"},Vs={key:3,class:"error-state small"},Ws={key:4,class:"preview-placeholder small"},Ks={key:0,class:"modal-overlay"},qs={class:"modal-dialog"},Qs={class:"modal-header"},Hs={class:"modal-body"},Xs={class:"selection-options"},Ys={class:"select-all-container"},Zs={class:"character-options"},ei=["onUpdate:modelValue"],si={class:"modal-footer"},ii=["disabled"],ti={key:1,class:"modal-overlay"},ri={class:"modal-dialog"},oi={class:"modal-header"},ni={class:"modal-body"},ai={class:"selection-options"},li={class:"select-all-container"},ci={class:"character-options"},ui=["onUpdate:modelValue"],gi={class:"modal-footer"},di=["disabled"];function hi(r,e,c,m,s,t){return n(),o(y,null,[a("div",Y,[s.isLoading?(n(),o("div",Z,e[19]||(e[19]=[a("i",{class:"fas fa-spinner fa-spin"},null,-1),h(" 加载资源中... ")]))):s.error?(n(),o("div",ee,[a("p",null,"加载资源失败: "+f(s.error),1)])):(n(),o("div",se,[a("div",ie,[!t.hasResources&&!t.hasMissingResources?(n(),o("div",te,[e[20]||(e[20]=a("p",null,"此故事暂无资源文件。",-1)),!s.audioDirExists&&!s.imageDirExists&&!s.musicDirExists&&!s.storyDirExists&&!s.characterFileExists?(n(),o("p",re,"(对应的资源目录或文件不存在)")):k("",!0)])):(n(),o("div",oe,[t.hasAudioResources||t.hasMissingAudioResources?(n(),o("div",ne,[e[30]||(e[30]=a("h3",null,"语音 (audio)",-1)),(n(!0),o(y,null,p(t.classifiedAudio.byStory,(i,l)=>(n(),o("div",{key:"audio-story-"+l,class:"voice-folder"},[a("h4",null," 故事片段 "+f(l),1),a("ul",ae,[(n(!0),o(y,null,p(i,u=>(n(),o("li",{key:u.file.path,class:E({selected:s.selectedResource&&s.selectedResource.path===u.file.path}),onClick:g=>t.selectResource(u.file,"audio")},[e[21]||(e[21]=a("i",{class:"fas fa-volume-up resource-icon"},null,-1)),a("span",null,f(u.text||`[${u.file.name}]`),1)],10,le))),128)),(n(!0),o(y,null,p(t.getMissingAudioForStory(l),u=>(n(),o("li",{key:"missing-"+u.id,class:"missing-resource",onClick:g=>t.handleMissingResourceClick(u)},[s.isGenerating[`audio-${l}-${u.id}`]?(n(),o("i",ue)):(n(),o("i",ge)),a("span",null,[h(f(u.text)+" ",1),e[22]||(e[22]=a("span",{class:"missing-label"},"[不存在]",-1))]),a("button",{class:"btn-complete",onClick:x(g=>t.regenerateAudio(l),["stop"]),disabled:s.isGenerating[`audio-${l}-${u.id}`]},[s.isGenerating[`audio-${l}-${u.id}`]?(n(),o("i",he)):(n(),o("i",me)),e[23]||(e[23]=h(" 补齐 "))],8,de)],8,ce))),128))])]))),128)),(n(!0),o(y,null,p(s.missingAudioByStory,(i,l)=>(n(),o(y,{key:"missing-story-audio-"+l},[t.classifiedAudio.byStory[l]?k("",!0):(n(),o("div",fe,[a("h4",null,[h(" 故事片段 "+f(l)+" ",1),e[25]||(e[25]=a("span",{class:"missing-section-label"},"[缺失]",-1)),a("button",{class:"btn-regenerate",onClick:u=>t.regenerateAudio(l),disabled:s.isGenerating[`audio-${l}`]},[s.isGenerating[`audio-${l}`]?(n(),o("i",pe)):(n(),o("i",ke)),e[24]||(e[24]=h(" 重新生成 "))],8,ye)]),a("ul",be,[(n(!0),o(y,null,p(i,u=>(n(),o("li",{key:"missing-full-"+u.id,class:"missing-resource",onClick:g=>t.handleMissingResourceClick(u)},[s.isGenerating[`audio-${l}-${u.id}`]?(n(),o("i",we)):(n(),o("i",_e)),a("span",null,[h(f(u.text)+" ",1),e[26]||(e[26]=a("span",{class:"missing-label"},"[不存在]",-1))]),a("button",{class:"btn-complete",onClick:x(g=>t.regenerateAudio(l),["stop"]),disabled:s.isGenerating[`audio-${l}-${u.id}`]},[s.isGenerating[`audio-${l}-${u.id}`]?(n(),o("i",Se)):(n(),o("i",Re)),e[27]||(e[27]=h(" 补齐 "))],8,Ce)],8,ve))),128))])]))],64))),128)),t.classifiedAudio.uncategorized.length>0?(n(),o("div",Ae,[e[29]||(e[29]=a("h4",null,"其他语音 (路径或关联错误)",-1)),a("ul",De,[(n(!0),o(y,null,p(t.classifiedAudio.uncategorized,i=>(n(),o("li",{key:i.path,class:E({selected:s.selectedResource&&s.selectedResource.path===i.path}),onClick:l=>t.selectResource(i,"audio")},[e[28]||(e[28]=a("i",{class:"fas fa-volume-up resource-icon"},null,-1)),a("span",null,f(i.name),1)],10,Ee))),128))])])):k("",!0)])):k("",!0),t.hasImageResources||t.hasMissingImageResources?(n(),o("div",xe,[e[52]||(e[52]=a("h3",null,"图片 (images)",-1)),t.classifiedImages.title.length>0||s.missingTitleImage?(n(),o("div",Be,[a("h4",null,[e[32]||(e[32]=h(" 封面图片 ")),a("button",{class:"btn-regenerate",onClick:e[0]||(e[0]=i=>t.regenerateTitleImage()),disabled:s.isGenerating["image-title"]},[s.isGenerating["image-title"]?(n(),o("i",Ie)):(n(),o("i",Ge)),e[31]||(e[31]=h(" 重新生成 "))],8,Me)]),a("ul",Ne,[(n(!0),o(y,null,p(t.classifiedImages.title,i=>(n(),o("li",{key:i.path,class:E({selected:s.selectedResource&&s.selectedResource.path===i.path}),onClick:l=>t.selectResource(i,"image")},[e[33]||(e[33]=a("i",{class:"fas fa-image resource-icon"},null,-1)),a("span",null,f(i.name),1)],10,Fe))),128)),s.missingTitleImage?(n(),o("li",{key:0,class:"missing-resource",onClick:e[2]||(e[2]=i=>t.handleMissingResourceClick(s.missingTitleImage))},[s.isGenerating["image-title"]?(n(),o("i",je)):(n(),o("i",Te)),e[35]||(e[35]=a("span",null,[h("title.png "),a("span",{class:"missing-label"},"[不存在]")],-1)),a("button",{class:"btn-complete",onClick:e[1]||(e[1]=x(i=>t.regenerateTitleImage(),["stop"])),disabled:s.isGenerating["image-title"]},[s.isGenerating["image-title"]?(n(),o("i",Ue)):(n(),o("i",Oe)),e[34]||(e[34]=h(" 补齐 "))],8,Le)])):k("",!0)])])):k("",!0),t.classifiedImages.characters.length>0||s.missingCharacterImages.length>0?(n(),o("div",Pe,[a("h4",null,[e[37]||(e[37]=h(" 人物 ")),a("button",{class:"btn-regenerate",onClick:e[3]||(e[3]=i=>t.showCharacterSelection(!0)),disabled:s.isGenerating["image-characters"]},[s.isGenerating["image-characters"]?(n(),o("i",$e)):(n(),o("i",ze)),e[36]||(e[36]=h(" 重新生成 "))],8,Je)]),a("ul",Ve,[(n(!0),o(y,null,p(t.classifiedImages.characters,i=>(n(),o("li",{key:i.path,class:E({selected:s.selectedResource&&s.selectedResource.path===i.path}),onClick:l=>t.selectResource(i,"image")},[e[38]||(e[38]=a("i",{class:"fas fa-image resource-icon"},null,-1)),a("span",null,f(i.name),1)],10,We))),128)),(n(!0),o(y,null,p(s.missingCharacterImages,i=>(n(),o("li",{key:"missing-char-"+i.name,class:"missing-resource",onClick:l=>t.handleMissingResourceClick(i)},[s.isGenerating[`image-character-${i.name}`]?(n(),o("i",qe)):(n(),o("i",Qe)),a("span",null,[h(f(i.name)+".png ",1),e[39]||(e[39]=a("span",{class:"missing-label"},"[不存在]",-1))]),a("button",{class:"btn-complete",onClick:e[4]||(e[4]=x(l=>t.showCharacterSelection(!1),["stop"])),disabled:s.isGenerating["image-characters"]||t.isAnyCharacterGenerating},[s.isGenerating["image-characters"]||t.isAnyCharacterGenerating?(n(),o("i",Xe)):(n(),o("i",Ye)),e[40]||(e[40]=h(" 补齐 "))],8,He)],8,Ke))),128))])])):k("",!0),Object.keys(t.classifiedImages.backgrounds.byStory).length>0||Object.keys(s.missingBackgroundsByStory).length>0?(n(),o("div",Ze,[e[49]||(e[49]=a("h4",null,"背景图 (按故事片段)",-1)),(n(!0),o(y,null,p(t.classifiedImages.backgrounds.byStory,(i,l)=>(n(),o("div",{key:"bg-story-"+l,class:"voice-folder sub-folder"},[a("h5",null,[h(" 故事片段 "+f(l)+" ",1),a("button",{class:"btn-regenerate",onClick:u=>t.showBackgroundSelection(l,!0),disabled:s.isGenerating[`image-bg-${l}`]},[s.isGenerating[`image-bg-${l}`]?(n(),o("i",ss)):(n(),o("i",is)),e[41]||(e[41]=h(" 重新生成 "))],8,es)]),a("ul",ts,[(n(!0),o(y,null,p(i,u=>(n(),o("li",{key:u.path,class:E({selected:s.selectedResource&&s.selectedResource.path===u.path}),onClick:g=>t.selectResource(u,"image")},[e[42]||(e[42]=a("i",{class:"fas fa-image resource-icon"},null,-1)),a("span",null,f(u.name),1)],10,rs))),128)),(n(!0),o(y,null,p(t.getMissingBackgroundsForStory(l),u=>(n(),o("li",{key:"missing-bg-"+l+"-"+u.name,class:"missing-resource",onClick:g=>t.handleMissingResourceClick(u)},[s.isGenerating[`image-bg-${l}-${u.name}`]?(n(),o("i",ns)):(n(),o("i",as)),a("span",null,[h(f(u.name)+".png ",1),e[43]||(e[43]=a("span",{class:"missing-label"},"[不存在]",-1))]),a("button",{class:"btn-complete",onClick:x(g=>t.showBackgroundSelection(l,!1),["stop"]),disabled:s.isGenerating[`image-bg-${l}`]},[s.isGenerating[`image-bg-${l}`]?(n(),o("i",cs)):(n(),o("i",us)),e[44]||(e[44]=h(" 补齐 "))],8,ls)],8,os))),128))])]))),128)),(n(!0),o(y,null,p(s.missingBackgroundsByStory,(i,l)=>(n(),o(y,{key:"missing-bg-story-"+l},[t.classifiedImages.backgrounds.byStory[l]?k("",!0):(n(),o("div",gs,[a("h5",null,[h(" 故事片段 "+f(l)+" ",1),e[46]||(e[46]=a("span",{class:"missing-section-label"},"[缺失]",-1)),a("button",{class:"btn-regenerate",onClick:u=>t.showBackgroundSelection(l,!0),disabled:s.isGenerating[`image-bg-${l}`]},[s.isGenerating[`image-bg-${l}`]?(n(),o("i",hs)):(n(),o("i",ms)),e[45]||(e[45]=h(" 重新生成 "))],8,ds)]),a("ul",fs,[(n(!0),o(y,null,p(i,u=>(n(),o("li",{key:"missing-bg-full-"+l+"-"+u.name,class:"missing-resource",onClick:g=>t.handleMissingResourceClick(u)},[s.isGenerating[`image-bg-${l}-${u.name}`]?(n(),o("i",ps)):(n(),o("i",ks)),a("span",null,[h(f(u.name)+".png ",1),e[47]||(e[47]=a("span",{class:"missing-label"},"[不存在]",-1))]),a("button",{class:"btn-complete",onClick:x(g=>t.showBackgroundSelection(l,!1),["stop"]),disabled:s.isGenerating[`image-bg-${l}`]},[s.isGenerating[`image-bg-${l}`]?(n(),o("i",vs)):(n(),o("i",ws)),e[48]||(e[48]=h(" 补齐 "))],8,bs)],8,ys))),128))])]))],64))),128))])):k("",!0),t.classifiedImages.backgrounds.uncategorized.length>0?(n(),o("div",_s,[e[51]||(e[51]=a("h4",null,"背景图 (未关联场景)",-1)),a("ul",Cs,[(n(!0),o(y,null,p(t.classifiedImages.backgrounds.uncategorized,i=>(n(),o("li",{key:i.path,class:E({selected:s.selectedResource&&s.selectedResource.path===i.path}),onClick:l=>t.selectResource(i,"image")},[e[50]||(e[50]=a("i",{class:"fas fa-image resource-icon"},null,-1)),a("span",null,f(i.name),1)],10,Ss))),128))])])):k("",!0)])):k("",!0),t.hasMusicResources||s.missingMusicFiles.length>0?(n(),o("div",Rs,[a("h3",null,[e[54]||(e[54]=h(" 音乐 (music) ")),a("button",{class:"btn-regenerate",onClick:e[5]||(e[5]=i=>t.regenerateMusic()),disabled:s.isGenerating.music},[s.isGenerating.music?(n(),o("i",Ds)):(n(),o("i",Es)),e[53]||(e[53]=h(" 重新生成 "))],8,As)]),a("ul",xs,[(n(!0),o(y,null,p(s.resourceCategories.music,i=>(n(),o("li",{key:i.path,class:E({selected:s.selectedResource&&s.selectedResource.path===i.path}),onClick:l=>t.selectResource(i,"audio")},[e[55]||(e[55]=a("i",{class:"fas fa-music resource-icon"},null,-1)),a("span",null,f(i.name),1)],10,Bs))),128)),(n(!0),o(y,null,p(s.missingMusicFiles,i=>(n(),o("li",{key:"missing-music-"+i.name,class:"missing-resource",onClick:l=>t.handleMissingResourceClick(i)},[s.isGenerating.music?(n(),o("i",Is)):(n(),o("i",Gs)),a("span",null,[h(f(i.name)+" ",1),e[56]||(e[56]=a("span",{class:"missing-label"},"[不存在]",-1))]),a("button",{class:"btn-complete",onClick:e[6]||(e[6]=x(l=>t.regenerateMusic(),["stop"])),disabled:s.isGenerating.music},[s.isGenerating.music?(n(),o("i",Fs)):(n(),o("i",js)),e[57]||(e[57]=h(" 补齐 "))],8,Ns)],8,Ms))),128))])])):k("",!0)]))]),a("div",Ts,[s.selectedResource?(n(),o("div",Us,[a("h4",null,"预览: "+f(s.selectedResource.name),1),a("div",Os,[s.selectedResource.type==="image"&&s.previewUrl&&!s.loadingPreview&&!s.previewError?(n(),o("img",{key:0,src:s.previewUrl,alt:"预览图片",class:"preview-image"},null,8,Ps)):s.selectedResource.type==="audio"&&s.previewUrl?(n(),o("div",Js,[a("audio",{ref:"audioPlayer",controls:"",src:s.previewUrl,onError:e[7]||(e[7]=(...i)=>t.handleAudioError&&t.handleAudioError(...i)),onEnded:e[8]||(e[8]=(...i)=>t.handleAudioEnded&&t.handleAudioEnded(...i))}," 您的浏览器不支持 Audio 标签，请尝试更新浏览器。 ",40,$s)])):k("",!0),s.loadingPreview?(n(),o("div",zs,e[58]||(e[58]=[a("i",{class:"fas fa-spinner fa-spin"},null,-1),h(" 加载预览中... ")]))):k("",!0),s.previewError&&!s.loadingPreview?(n(),o("div",Vs," 加载或播放预览失败 ")):k("",!0),s.selectedResource&&!s.previewUrl&&!s.loadingPreview&&!s.previewError?(n(),o("div",Ws," 此文件类型不支持预览 ")):k("",!0)])])):(n(),o("div",Ls," 选择一个资源进行预览 "))])]))]),s.showCharacterDialog?(n(),o("div",Ks,[a("div",qs,[a("div",Qs,[e[59]||(e[59]=a("h3",null,"选择需要生成的人物",-1)),a("button",{class:"close-btn",onClick:e[9]||(e[9]=(...i)=>t.closeCharacterDialog&&t.closeCharacterDialog(...i))},"×")]),a("div",Hs,[a("div",Xs,[a("label",Ys,[I(a("input",{type:"checkbox","onUpdate:modelValue":e[10]||(e[10]=i=>s.selectAllCharacters=i),onChange:e[11]||(e[11]=(...i)=>t.toggleAllCharacters&&t.toggleAllCharacters(...i))},null,544),[[G,s.selectAllCharacters]]),e[60]||(e[60]=a("span",null,"全选",-1))]),a("div",Zs,[(n(!0),o(y,null,p(s.characterSelectionList,i=>(n(),o("label",{key:i.name},[I(a("input",{type:"checkbox","onUpdate:modelValue":l=>i.selected=l},null,8,ei),[[G,i.selected]]),a("span",null,f(i.name),1)]))),128))])])]),a("div",si,[a("button",{class:"btn-cancel",onClick:e[12]||(e[12]=(...i)=>t.closeCharacterDialog&&t.closeCharacterDialog(...i))},"取消"),a("button",{class:"btn-confirm",onClick:e[13]||(e[13]=(...i)=>t.confirmCharacterSelection&&t.confirmCharacterSelection(...i)),disabled:!t.hasSelectedCharacters}," 确认 ",8,ii)])])])):k("",!0),s.showBackgroundDialog?(n(),o("div",ti,[a("div",ri,[a("div",oi,[a("h3",null,"选择需要生成的背景 (故事片段 "+f(s.currentStoryId)+")",1),a("button",{class:"close-btn",onClick:e[14]||(e[14]=(...i)=>t.closeBackgroundDialog&&t.closeBackgroundDialog(...i))},"×")]),a("div",ni,[a("div",ai,[a("label",li,[I(a("input",{type:"checkbox","onUpdate:modelValue":e[15]||(e[15]=i=>s.selectAllBackgrounds=i),onChange:e[16]||(e[16]=(...i)=>t.toggleAllBackgrounds&&t.toggleAllBackgrounds(...i))},null,544),[[G,s.selectAllBackgrounds]]),e[61]||(e[61]=a("span",null,"全选",-1))]),a("div",ci,[(n(!0),o(y,null,p(s.backgroundSelectionList,i=>(n(),o("label",{key:i.name},[I(a("input",{type:"checkbox","onUpdate:modelValue":l=>i.selected=l},null,8,ui),[[G,i.selected]]),a("span",null,f(i.name),1)]))),128))])])]),a("div",gi,[a("button",{class:"btn-cancel",onClick:e[17]||(e[17]=(...i)=>t.closeBackgroundDialog&&t.closeBackgroundDialog(...i))},"取消"),a("button",{class:"btn-confirm",onClick:e[18]||(e[18]=(...i)=>t.confirmBackgroundSelection&&t.confirmBackgroundSelection(...i)),disabled:!t.hasSelectedBackgrounds}," 确认 ",8,di)])])])):k("",!0)],64)}const fi=J(X,[["render",hi],["__scopeId","data-v-9efa32ae"]]);export{fi as default};
