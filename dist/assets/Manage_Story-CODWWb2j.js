const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ExportStory-CXeBCkPk.js","assets/index-DyH5Twdd.js","assets/index-6bJn0v1y.css","assets/ExportStory-ChGJjoSq.css","assets/Manage_readresources-BEE5uyu4.js","assets/Manage_readresources-DNB8Yr35.css"])))=>i.map(i=>d[i]);
import{_ as b,r as p,c,o as a,a as n,b as m,d as u,e as h,F as k,f as R,t as w,w as y,g as v,h as C,n as g,i as S,j as M,k as _,l as T,m as U}from"./index-DyH5Twdd.js";const L={name:"ManageStory",data(){return{isLoading:!0,stories:[],showContentModal:!1,contentWindowLoaded:!1,animateContentWindow:!1,ExportStoryComponent:null,currentStoryTitle:"",showResourcesModal:!1,resourcesWindowLoaded:!1,animateResourcesWindow:!1,ReadResourcesComponent:null,objectUrls:{}}},async mounted(){this.fetchStories()},beforeDestroy(){this.releaseObjectUrls()},methods:{async fetchStories(){this.isLoading=!0,this.stories=[],this.releaseObjectUrls();try{const e=await T();let o=e.indexOf("test");o!==-1&&e.splice(o,1),console.log("Fetched story titles:",e),this.stories=await Promise.all(e.map(async t=>{const l={title:t,coverUrl:null,loadingCover:!0};try{const i=await U(`/data/${t}/images/title.png`);if(i instanceof Blob){const r=URL.createObjectURL(i);l.coverUrl=r,this.objectUrls[t]=r,console.log(`Loaded cover for ${t}`)}else console.warn(`Cover for ${t} is not a Blob or ArrayBuffer, or file not found.`),l.coverUrl=null}catch(i){console.warn(`Failed to load cover for "${t}":`,i),l.coverUrl=null}finally{l.loadingCover=!1}return l})),this.stories.sort((t,l)=>t.title.localeCompare(l.title))}catch(e){console.error("加载故事列表失败:",e),this.showNotification("加载故事列表失败","error")}finally{this.isLoading=!1}},onCoverError(e){console.warn(`Error loading cover image for "${e.title}", falling back to default icon.`),e.coverUrl=null},async viewStoryContent(e){if(this.currentStoryTitle=e.title,this.showContentModal=!0,this.contentWindowLoaded=!1,!this.ExportStoryComponent)try{const o=await _(()=>import("./ExportStory-CXeBCkPk.js"),__vite__mapDeps([0,1,2,3]));this.ExportStoryComponent=o.default}catch(o){console.error("加载 ExportStory.vue 组件失败:",o),this.showNotification("加载故事内容查看器失败","error"),this.closeContentModal();return}this.$nextTick(()=>{this.animateContentWindow=!0,setTimeout(()=>{this.contentWindowLoaded=!0},300)})},closeContentModal(){this.animateContentWindow=!1,setTimeout(()=>{this.showContentModal=!1,this.contentWindowLoaded=!1,this.currentStoryTitle=""},300)},async viewStoryResources(e){if(this.currentStoryTitle=e.title,this.showResourcesModal=!0,this.resourcesWindowLoaded=!1,!this.ReadResourcesComponent)try{const o=await _(()=>import("./Manage_readresources-BEE5uyu4.js"),__vite__mapDeps([4,1,2,5]));this.ReadResourcesComponent=o.default}catch(o){console.error("加载 readresources.vue 组件失败:",o),this.showNotification("加载故事资源查看器失败","error"),this.closeResourcesModal();return}this.$nextTick(()=>{this.animateResourcesWindow=!0,setTimeout(()=>{this.resourcesWindowLoaded=!0},300)})},closeResourcesModal(){this.animateResourcesWindow=!1,setTimeout(()=>{this.showResourcesModal=!1,this.resourcesWindowLoaded=!1,this.currentStoryTitle=""},300)},async renameStory(e){const o=e.title,t=prompt(`请输入 "${o}" 的新名称:`,o);if(t&&t.trim()!==""&&t!==o){if(t.includes("/")||t.includes("\\")||t.includes(".")){this.showNotification("故事名称不能包含 / \\ .","warning");return}if(this.stories.some(l=>l.title===t.trim())){this.showNotification(`故事 "${t.trim()}" 已存在`,"warning");return}try{await M(`/data/${o}`,t.trim()),console.log(`故事 "${o}" 已重命名为 "${t.trim()}"`),this.showNotification(`故事 "${o}" 已重命名为 "${t.trim()}"`,"success"),this.fetchStories()}catch(l){console.error(`重命名故事 "${o}" 失败:`,l),this.showNotification(`重命名故事 "${o}" 失败`,"error")}}else console.log(t===o?"新名称与原名称相同，取消重命名":"重命名操作已取消")},async deleteStory(e){const o=e.title;if(confirm(`确定要删除故事 "${o}" 吗？此操作不可逆！`))try{await S(`/data/${o}`),console.log(`故事 "${o}" 已删除`),this.showNotification(`故事 "${o}" 已删除`,"success"),this.stories=this.stories.filter(l=>l.title!==o),this.objectUrls[o]&&(URL.revokeObjectURL(this.objectUrls[o]),delete this.objectUrls[o])}catch(l){console.error(`删除故事 "${o}" 失败:`,l),this.showNotification(`删除故事 "${o}" 失败`,"error")}else console.log("删除操作已取消")},releaseObjectUrls(){for(const e in this.objectUrls)Object.prototype.hasOwnProperty.call(this.objectUrls,e)&&this.objectUrls[e]&&URL.revokeObjectURL(this.objectUrls[e]);this.objectUrls={}},showNotification(e,o="info"){this.$emit("show-message",{title:o,message:e}),console.log(`[ManageStory][${o.toUpperCase()}] ${e}`)}}},j={class:"story-management"},W={key:0,class:"loading-indicator"},E={key:1,class:"empty-state"},N={key:2,class:"story-list"},x={class:"story-info"},O={class:"story-cover"},B=["src","onError"],D={key:1,class:"default-icon"},P={class:"story-title"},V={key:0,class:"loading-cover"},$={class:"story-actions"},F=["onClick"],A=["onClick"],I=["onClick"],z=["onClick"],q={class:"window-header"},G={class:"window-content"},H={key:1,class:"loading-indicator"},J={class:"window-header"},K={class:"window-content"},Q={key:1,class:"loading-indicator"};function X(e,o,t,l,i,r){const d=p("font-awesome-icon");return a(),c("div",j,[o[11]||(o[11]=n("h2",null,"游戏故事管理",-1)),i.isLoading?(a(),c("div",W,[u(d,{icon:["fas","spinner"],spin:"",class:"loading-icon-fa"}),o[6]||(o[6]=h(" 加载故事列表中... "))])):i.stories.length===0?(a(),c("div",E,[n("p",null,[u(d,{icon:["fas","info-circle"],class:"empty-icon-fa"}),o[7]||(o[7]=h(" 还没有任何故事。是时候创造新的冒险了！ "))])])):(a(),c("ul",N,[(a(!0),c(k,null,R(i.stories,s=>(a(),c("li",{key:s.title,class:"story-item"},[n("div",x,[n("div",O,[s.coverUrl?(a(),c("img",{key:0,src:s.coverUrl,alt:"封面",class:"cover-image",onError:f=>r.onCoverError(s)},null,40,B)):(a(),c("div",D,[u(d,{icon:["fas","book"]})]))]),n("span",P,w(s.title),1),s.loadingCover?(a(),c("span",V,[u(d,{icon:["fas","spinner"],spin:""}),o[8]||(o[8]=h(" 加载封面... "))])):m("",!0)]),n("div",$,[n("button",{onClick:f=>r.viewStoryContent(s),class:"action-button icon-button",title:"查看内容"},[u(d,{icon:["fas","eye"]})],8,F),n("button",{onClick:f=>r.viewStoryResources(s),class:"action-button icon-button",title:"查看资源"},[u(d,{icon:["fas","boxes-stacked"]})],8,A),n("button",{onClick:f=>r.renameStory(s),class:"action-button icon-button",title:"重命名"},[u(d,{icon:["fas","pen"]})],8,I),n("button",{onClick:f=>r.deleteStory(s),class:"action-button icon-button",title:"删除"},[u(d,{icon:["fas","trash-alt"]})],8,z)])]))),128))])),i.showContentModal?(a(),c("div",{key:3,class:"floating-window-container",onClick:o[2]||(o[2]=y((...s)=>r.closeContentModal&&r.closeContentModal(...s),["self"]))},[n("div",{class:g(["floating-window",{"animate-in":i.animateContentWindow}])},[n("div",q,[n("h2",null,"查看故事内容: "+w(i.currentStoryTitle),1),n("button",{class:"close-button",onClick:o[0]||(o[0]=(...s)=>r.closeContentModal&&r.closeContentModal(...s))},[u(d,{icon:["fas","times"]})])]),n("div",G,[i.contentWindowLoaded?(a(),v(C(i.ExportStoryComponent),{key:0,storyTitle:i.currentStoryTitle,onClose:r.closeContentModal,onShowMessage:o[1]||(o[1]=s=>e.$emit("show-message",s))},null,40,["storyTitle","onClose"])):(a(),c("div",H,[u(d,{icon:["fas","spinner"],spin:"",class:"loading-icon-fa"}),o[9]||(o[9]=h(" 加载中... "))]))])],2)])):m("",!0),i.showResourcesModal?(a(),c("div",{key:4,class:"floating-window-container",onClick:o[5]||(o[5]=y((...s)=>r.closeResourcesModal&&r.closeResourcesModal(...s),["self"]))},[n("div",{class:g(["floating-window",{"animate-in":i.animateResourcesWindow}])},[n("div",J,[n("h2",null,"查看故事资源: "+w(i.currentStoryTitle),1),n("button",{class:"close-button",onClick:o[3]||(o[3]=(...s)=>r.closeResourcesModal&&r.closeResourcesModal(...s))},[u(d,{icon:["fas","times"]})])]),n("div",K,[i.resourcesWindowLoaded?(a(),v(C(i.ReadResourcesComponent),{key:0,storyTitle:i.currentStoryTitle,onClose:r.closeResourcesModal,onShowMessage:o[4]||(o[4]=s=>e.$emit("show-message",s))},null,40,["storyTitle","onClose"])):(a(),c("div",Q,[u(d,{icon:["fas","spinner"],spin:"",class:"loading-icon-fa"}),o[10]||(o[10]=h(" 加载中... "))]))])],2)])):m("",!0)])}const Z=b(L,[["render",X],["__scopeId","data-v-e0e086a4"]]);export{Z as default};
